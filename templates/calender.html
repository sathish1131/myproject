{% extends 'background.html' %}
{% load static %}

{% block title %}Calender{% endblock %}
{% block page_title %}Calender{% endblock %}

{% block content %}

<div class="calender-header">
    <div>
        <label for="month">Month</label>
        <select class="calender-dropdown" name="month" id="month">
            {% for month in months %}
            <option value="{{ forloop.counter }}" {% if forloop.counter == current_month %}selected{% endif %}>{{ month }}
            </option>
            {% endfor %}
        </select>
    </div>
    <div>
        <label for="year">Year</label>
        <select class="calender-dropdown" name="year" id="year">
            {% for year in years %}
            <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
        </select>
    </div>
    <div>
        <label for="decade">Decade</label>
        <select class="calender-dropdown" name="decade" id="decade">
            {% for decade in decades %}
            <option value="{{ decade }}" {% if decade == current_decade %}selected{% endif %}>{{ decade }}</option>
            {% endfor %}
        </select>
    </div>
</div>
<div class="app-content" style="display: flex; flex-direction:column;">
    <div class="calender-layout">
        {{ calender|safe }}
    </div>
    <div class="event-layout">
        <div style="justify-content: right; text-align:right; padding: 10px 20px;">
            <button type="button" class="add-button" data-bs-toggle="modal" data-bs-target="#addEventModal">Add Event</button>
        </div>
        <table id="event-table" class="event-table">
            <thead>
                <tr>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Event Description</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>
<div class="modal fade" tabindex="-1" id="addEventModal" aria-labelledby="addEventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addEventModalLabel">Add New Event</h5>
                <button type="close" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                </button>
            </div>
            <div class="modal-body">
                <form id="add-event-form" method="POST">
                    {% csrf_token %}
                    <div class="mb-3"  style="display: flex; flex-direction: row; justify-content:space-around;">
                        <div>
                            <label for="start-time">Start time</label>
                            <select name="start-time" id="start-time" class="form-control">
                                {% for time in times %}
                                <option value="{{ time }}">{{ time }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="end-time">End time</label>
                            <select name="end-time" id="end-time" class="form-control">
                                {% for time in times %}
                                <option value="{{ time }}">{{ time }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="event-description">Event Description</label>
                        <textarea name="event-description" id="event-description" class="form-control" rows="3"></textarea>
                    </div>
                    <button type="submit" class="add-button">Add Event</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" tabindex="-1" id="editEventModal" aria-labelledby="editEventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editEventModalLabel">Edit Event</h5>
                <button type="close" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                </button>
            </div>
            <div class="modal-body">
                <form id="edit-task-form" method="post" action="">
                    {% csrf_token %}
                    <input type="hidden" name="event_id" id="edit-event-id">
                    <div class="mb-3"  style="display: flex; flex-direction: row; justify-content:space-around;">
                        <div>
                            <label for="start-time">Start time</label>
                            <select name="start-time" id="start-time" class="form-control">
                                {% for time in times %}
                                <option value="{{ time }}">{{ time }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="end-time">End time</label>
                            <select name="end-time" id="end-time" class="form-control">
                                {% for time in times %}
                                <option value="{{ time }}">{{ time }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit-event-description">Event Description</label>
                        <textarea name="edit-event-description" id="edit-event-description" class="form-control" rows="3"></textarea>
                    </div>
                    <button type="submit" class="update-button">Save Event</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" tabindex="-1" id="deleteEventModal" aria-labelledby="deleteEventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteEventModalLabel">Delete Event</h5>
                <button type="close" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                </button>
            </div>
            <div class="modal-body">
                <form action="" method="post" id="delete-event-form">
                    {% csrf_token %}
                    <p>Confirm Delete Task</p>
                    <div class="modal-footer">
                        <button class="update-button" type="button" data-bs-dismiss="modal"
                            id="cancel-delete">Cancel</button>
                        <button class="update-button" type="submit" id="confirm-delete"
                            style="background-color: red;">Delete</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script src="{% static 'jquery-3.7.1.min.js' %}"></script>
<script>

    $(document).ready(function () {
        let eventYear = $('#year').val();
        let eventMonth = $('#month').val();
        let eventDate;
        let dateBoxes = document.querySelectorAll('td');
        dateBoxes.forEach(dateBox => {
            if (dateBox.textContent.trim() == '{{ current_date }}') {
                dateBox.style.backgroundColor = '#32CD32';
                eventDate = '{{ current_date }}';
            }
        });

        loadEvents(eventYear, eventMonth, eventDate);

        $('#month').on('change', function () {
            let selectedMonth = $(this).val();
            let selectedYear = $('#year').val();
            $.ajax({
                type: 'GET',
                url: '{% url "fetch_calender" %}',
                data: {
                    month: selectedMonth,
                    year: selectedYear
                },
                success: function (response) {
                    $('.calender-layout').html(response.calender);
                },
                error: function (error) {
                    alert(error);
                }
            })
        });

        $('#year').on('change', function () {
            let selectedYear = $(this).val();
            let selectedMonth = $('#month').val();
            $.ajax({
                type: 'GET',
                url: '{% url "fetch_calender" %}',
                data: {
                    month: selectedMonth,
                    year: selectedYear
                },
                success: function (response) {
                    $('.calender-layout').html(response.calender);
                },
                error: function (error) {
                    alert(error);
                }
            })
        });

        $('#decade').on('change', function () {
            let selectedDecade = $(this).val();
            let yearDropdown = document.getElementById('year');
            $.ajax({
                type: 'GET',
                url: '{% url "fetch_years" %}',
                data: { 'selected_decade': selectedDecade },
                success: function (response) {
                    yearDropdown.innerHTML = '';
                    response.years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year
                        option.textContent = year
                        yearDropdown.appendChild(option);
                    });
                },
                error: function (error) {
                    alert(error);
                }
            });
        });

        $(document).on('click', '.calender-layout td', function () {
            let eventYear = $('#year').val();
            let eventMonth = $('#month').val();
            let eventDate = $(this).text();
            loadEvents(eventYear, eventMonth, eventDate);
        });

        function loadEvents(year,month, date){
            $.ajax({
                method: 'GET',
                url: '{% url "fetch_events" %}',
                data: {
                    'event_year': year,
                    'event_month': month,
                    'event_date': date
                },
                success: function(response){
                    $('#event-table tbody').empty();
                    response.events.forEach(function(event){
                        let row = $('<tr></tr>');
                        let eventStartTimeCell = $('<td></td>').text(event.start_time);
                        let eventEndTimeCell = $('<td></td>').text(event.end_time);
                        let eventDescriptionCell = $('<td></td>').text(event.event);
                        let eventActionCell = $('<td style="justify-content:center;text-align:center;"></td>').html(`
                        <a href="" class="btn btn-link" style="margin-right:10px;text-align:center;"
                            data-id="${event.id}" id="edit-btn">
                            <i class="fas fa-edit" data-bs-toggle="modal" data-bs-target="#editEventModal"></i>
                        </a>
                        <a href="" class="btn btn-link ml-2" id="delete-btn"
                            style="margin-right:10px;text-align:center;" data-id="${event.id}">
                            <i class="fas fa-trash" data-bs-toggle="modal" data-bs-target="#deleteEventModal"></i>
                        </a>`);

                        row.append(eventStartTimeCell);
                        row.append(eventEndTimeCell);
                        row.append(eventDescriptionCell);
                        row.append(eventActionCell);

                        $('#event-table tbody').append(row);

                    });
                },
                error: function(error){
                    alert(error);
                }
            });
        }

    });
</script>

{% endblock %}